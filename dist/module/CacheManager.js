import _regeneratorRuntime from"@babel/runtime/regenerator";import _classCallCheck from"@babel/runtime/helpers/classCallCheck";import _createClass from"@babel/runtime/helpers/createClass";import*as _ from"lodash";import*as FileSystem from"expo-file-system";import SHA1 from"crypto-js/sha1";var BASE_DIR=FileSystem.cacheDirectory+"expo-image-cache/";export var CacheEntry=function(){function CacheEntry(uri,options,cacheKey){_classCallCheck(this,CacheEntry);this.uri=uri;this.options=options;this.cacheKey=cacheKey;}_createClass(CacheEntry,[{key:"getPath",value:function getPath(){var cacheKey,_ref,path,exists,tmpPath;return _regeneratorRuntime.async(function getPath$(_context){while(1){switch(_context.prev=_context.next){case 0:cacheKey=this.cacheKey;_context.next=3;return _regeneratorRuntime.awrap(getCacheEntry(cacheKey));case 3:_ref=_context.sent;path=_ref.path;exists=_ref.exists;tmpPath=_ref.tmpPath;if(!exists){_context.next=9;break;}return _context.abrupt("return",path);case 9:if(!this.downloadPromise){this.downloadPromise=this.download(path,tmpPath);}return _context.abrupt("return",this.downloadPromise);case 11:case"end":return _context.stop();}}},null,this);}},{key:"download",value:function download(path,tmpPath){var uri,options,result;return _regeneratorRuntime.async(function download$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:uri=this.uri,options=this.options;_context2.next=3;return _regeneratorRuntime.awrap(FileSystem.createDownloadResumable(uri,tmpPath,options).downloadAsync());case 3:result=_context2.sent;if(!(result&&result.status!==200)){_context2.next=7;break;}this.downloadPromise=undefined;return _context2.abrupt("return",undefined);case 7:_context2.next=9;return _regeneratorRuntime.awrap(FileSystem.moveAsync({from:tmpPath,to:path}));case 9:return _context2.abrupt("return",path);case 10:case"end":return _context2.stop();}}},null,this);}}]);return CacheEntry;}();var CacheManager=function(){function CacheManager(){_classCallCheck(this,CacheManager);}_createClass(CacheManager,null,[{key:"get",value:function get(uri,options,cacheKey){if(!CacheManager.entries[cacheKey]){CacheManager.entries[cacheKey]=new CacheEntry(uri,options,cacheKey);}return CacheManager.entries[cacheKey];}},{key:"clearCache",value:function clearCache(){return _regeneratorRuntime.async(function clearCache$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return _regeneratorRuntime.awrap(FileSystem.deleteAsync(BASE_DIR,{idempotent:true}));case 2:_context3.next=4;return _regeneratorRuntime.awrap(FileSystem.makeDirectoryAsync(BASE_DIR));case 4:case"end":return _context3.stop();}}});}},{key:"getCacheSize",value:function getCacheSize(){var result;return _regeneratorRuntime.async(function getCacheSize$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return _regeneratorRuntime.awrap(FileSystem.getInfoAsync(BASE_DIR));case 2:result=_context4.sent;if(result.exists){_context4.next=5;break;}throw new Error(BASE_DIR+" not found");case 5:return _context4.abrupt("return",result.size);case 6:case"end":return _context4.stop();}}});}}]);return CacheManager;}();CacheManager.entries={};export{CacheManager as default};var getCacheEntry=function getCacheEntry(cacheKey){var filename,ext,sha,path,tmpPath,info,exists;return _regeneratorRuntime.async(function getCacheEntry$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:filename=cacheKey.substring(cacheKey.lastIndexOf("/"),cacheKey.indexOf("?")===-1?cacheKey.length:cacheKey.indexOf("?"));ext=filename.indexOf(".")===-1?".jpg":filename.substring(filename.lastIndexOf("."));sha=SHA1(cacheKey);path=""+BASE_DIR+sha+ext;tmpPath=""+BASE_DIR+sha+"-"+_.uniqueId()+ext;_context5.prev=5;_context5.next=8;return _regeneratorRuntime.awrap(FileSystem.makeDirectoryAsync(BASE_DIR));case 8:_context5.next=12;break;case 10:_context5.prev=10;_context5.t0=_context5["catch"](5);case 12:_context5.next=14;return _regeneratorRuntime.awrap(FileSystem.getInfoAsync(path));case 14:info=_context5.sent;exists=info.exists;return _context5.abrupt("return",{exists:exists,path:path,tmpPath:tmpPath});case 17:case"end":return _context5.stop();}}},null,null,[[5,10]]);};
//# sourceMappingURL=CacheManager.js.map